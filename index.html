<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WaterPrinx - Weekly Usage with Auto Date</title>
  <style>
    /* Global & Reset */
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f0f4fa;
      color: #222;
      line-height: 1.5;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    header {
      width: 100%;
      background: #0a74da;
      color: white;
      padding: 1rem 2rem;
      box-shadow: 0 2px 6px rgb(10 116 218 / 0.4);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 100;
    }
    header h1 {
      margin: 0;
      font-weight: 700;
      font-size: 1.5rem;
      cursor: default;
    }
    nav {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    nav button {
      background: #1e90ff;
      border: none;
      color: white;
      font-weight: 600;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      font-size: 1rem;
    }
    nav button:hover, nav button:focus {
      background: #145ea8;
      outline: none;
    }
    main {
      max-width: 900px;
      width: 95%;
      margin-top: 80px;
      padding: 1rem 1.5rem 3rem 1.5rem;
      background: white;
      border-radius: 10px;
      box-shadow: 0 8px 18px rgb(0 0 0 / 0.1);
      min-height: 70vh;
    }
    h2 {
      margin-top: 0;
      font-weight: 700;
      color: #0a74da;
    }
    label {
      font-weight: 600;
      display: block;
      margin-bottom: 0.5rem;
    }
    select, input[type=number], input[type=text], input[type=date] {
      width: 100%;
      padding: 0.5rem;
      font-size: 1rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      margin-bottom: 1rem;
    }
    button.action-btn {
      background: #0a74da;
      color: white;
      padding: 0.75rem 1.5rem;
      font-weight: 700;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      margin-top: 0.5rem;
    }
    button.action-btn:hover, button.action-btn:focus {
      background: #064a85;
      outline: none;
    }
    #output {
      margin-top: 1rem;
      font-size: 1.25rem;
      font-weight: 600;
      color: #222;
      min-height: 2em;
      word-break: break-word;
    }
    #daily-usage-list {
      margin-top: 1rem;
      border-top: 1px solid #ccc;
      padding-top: 1rem;
      max-height: 250px;
      overflow-y: auto;
    }
    #daily-usage-list div {
      display: flex;
      justify-content: space-between;
      padding: 0.3rem 0;
      border-bottom: 1px solid #eee;
      font-size: 1rem;
    }
    #daily-usage-list div:last-child {
      border-bottom: none;
    }
    .remove-item-btn {
      background: #e74c3c;
      border: none;
      color: white;
      border-radius: 4px;
      padding: 0 6px;
      cursor: pointer;
      font-weight: bold;
      margin-left: 12px;
      transition: background-color 0.3s ease;
    }
    .remove-item-btn:hover, .remove-item-btn:focus {
      background: #b43127;
      outline: none;
    }
    #total-usage {
      margin-top: 1rem;
      font-weight: 700;
      font-size: 1.3rem;
      border-top: 2px solid #0a74da;
      padding-top: 0.5rem;
      color: #0a74da;
    }
    /* Settings list UI */
    #editable-actions-list {
      max-height: 300px;
      overflow-y: auto;
      margin-top: 1rem;
    }
    #editable-actions-list div {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.3rem 0.6rem;
      border-bottom: 1px solid #ddd;
    }
    #editable-actions-list div:last-child {
      border-bottom: none;
    }
    #editable-actions-list input[type=number] {
      width: 80px;
      margin-left: 1rem;
      font-size: 1rem;
    }
    #editable-actions-list label {
      flex-grow: 1;
      cursor: default;
    }
    /* Fix for graph container and canvas height */
    #graph-page {
      height: 400px;
    }
    #usage-chart {
      height: 100% !important;
      width: 100% !important;
      display: block;
    }

    @media (max-width: 900px) {
      main {
        max-width: 100%;
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>WaterPrinx</h1>
    <nav>
      <button onclick="navigate('main')" aria-label="Go to Main Page">Main Page</button>
      <button onclick="navigate('settings')" aria-label="Go to Settings">Water Actions Settings</button>
      <button onclick="navigate('graph')" aria-label="Go to Usage Graph">Usage Graph</button>
    </nav>
  </header>

  <main>
    <!-- Main Page -->
    <section id="main-page" style="display: none;">
      <h2>Calculate Water Footprint</h2>
      <div class="input-group">
        <label for="item-select">Select Activity</label>
        <select id="item-select"></select>
      </div>
      <div class="input-group">
        <label for="quantity-input">Quantity / Usage</label>
        <input type="number" id="quantity-input" min="1" value="1" />
      </div>
      <div class="input-group">
        <label for="date-input">Select Date</label>
        <input type="date" id="date-input" aria-label="Select date for water usage" />
      </div>
      <button class="action-btn" onclick="addDailyUsage()">Add to Daily Usage</button>

      <div id="daily-usage-list" aria-live="polite" aria-label="List of daily water usage activities"></div>
      <div id="total-usage" aria-live="polite" aria-label="Total water usage for the selected date"></div>
    </section>

    <!-- Settings Page -->
    <section id="settings-page" style="display: none;">
      <h2>Edit Water Actions Usage Amounts</h2>
      
      <label for="new-action-name">Add New Water Action</label>
      <input type="text" id="new-action-name" placeholder="Enter new action name" aria-label="New water action name" />
      
      <label for="new-action-usage">Water Usage Amount (litres per unit)</label>
      <input type="number" id="new-action-usage" min="0" step="1" placeholder="Enter usage amount in litres" aria-label="Water usage amount in litres" />
      
      <button class="action-btn" onclick="addNewAction()">Add Action</button>

      <div id="editable-actions-list" aria-live="polite" aria-label="List of water actions with editable usage amounts"></div>
      <button class="action-btn" onclick="saveFootprintChanges()">Save Changes</button>
    </section>

    <!-- Graph Page -->
    <section id="graph-page" style="display: none;">
      <h2>Weekly Water Usage (Litres)</h2>
      <canvas id="usage-chart"></canvas>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    let footprintValues = {
      'Shower': 50,
      'Toilet Flush': 8,
      'Washing Machine': 70,
      'Dishwasher': 15,
      'Cooking': 10,
      'Drinking': 2,
    };

    function loadFootprintValues() {
      const saved = localStorage.getItem('waterprinx_footprints');
      if (saved) {
        try {
          const parsed = JSON.parse(saved);
          if (parsed && typeof parsed === 'object') {
            footprintValues = parsed;
          }
        } catch (e) {/* ignore */}
      }
    }

    function saveFootprintValues() {
      localStorage.setItem('waterprinx_footprints', JSON.stringify(footprintValues));
    }

    function getItemList() {
      return Object.keys(footprintValues);
    }

    // Store weekly usage entries by date string (YYYY-MM-DD) mapping to array of entries:
    // { '2025-08-20': [{activity, quantity, footprint}], ... }
    let dateUsageEntries = {};

    function loadDateUsage() {
      const saved = localStorage.getItem('waterprinx_date_usage');
      if (saved) {
        try {
          const parsed = JSON.parse(saved);
          if (parsed && typeof parsed === 'object') {
            dateUsageEntries = parsed;
          }
        } catch (e) { /* ignore */ }
      }
    }
    function saveDateUsage() {
      localStorage.setItem('waterprinx_date_usage', JSON.stringify(dateUsageEntries));
    }

    function populateDropdown() {
      const select = document.getElementById('item-select');
      select.innerHTML = '';
      const items = getItemList();
      if (items.length === 0) {
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'No activities available';
        select.appendChild(option);
        select.disabled = true;
      } else {
        select.disabled = false;
        items.forEach(item => {
          const option = document.createElement('option');
          option.value = item;
          option.textContent = item;
          select.appendChild(option);
        });
      }
    }

    function renderDailyUsageList(dateStr) {
      const listDiv = document.getElementById('daily-usage-list');
      listDiv.innerHTML = '';
      const entries = dateUsageEntries[dateStr] || [];
      if (entries.length === 0) {
        listDiv.textContent = `No water usage entries for ${formatDate(dateStr)} yet.`;
        updateTotalUsage(dateStr);
        return;
      }

      entries.forEach((entry, idx) => {
        const div = document.createElement('div');
        const text = document.createElement('span');
        text.textContent = `${entry.quantity} × ${entry.activity} = ${entry.footprint.toLocaleString()} litres`;
        div.appendChild(text);

        const removeBtn = document.createElement('button');
        removeBtn.className = 'remove-item-btn';
        removeBtn.title = `Remove entry: ${entry.quantity} × ${entry.activity} on ${formatDate(dateStr)}`;
        removeBtn.setAttribute('aria-label', `Remove entry: ${entry.quantity} ${entry.activity} on ${formatDate(dateStr)}`);
        removeBtn.textContent = '×';
        removeBtn.onclick = () => {
          dateUsageEntries[dateStr].splice(idx, 1);
          if (dateUsageEntries[dateStr].length === 0) {
            delete dateUsageEntries[dateStr];
          }
          saveDateUsage();
          renderDailyUsageList(dateStr);
          renderGraph();
        };
        div.appendChild(removeBtn);

        listDiv.appendChild(div);
      });
      updateTotalUsage(dateStr);
    }

    function updateTotalUsage(dateStr) {
      const totalDiv = document.getElementById('total-usage');
      const entries = dateUsageEntries[dateStr] || [];
      const total = entries.reduce((sum, entry) => sum + entry.footprint, 0);
      totalDiv.textContent = `Total Water Used on ${formatDate(dateStr)}: ${total.toLocaleString()} litres`;
    }

    function formatDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      if (isNaN(date)) return dateStr;
      return date.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'short', day: 'numeric' });
    }

    // Helper to get weekday short form from date string (e.g., "Mon")
    function getWeekdayFromDate(dateStr) {
      if (!dateStr) return null;
      const date = new Date(dateStr);
      if (isNaN(date)) return null;
      const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      return days[date.getDay()];
    }

    function addDailyUsage() {
      const select = document.getElementById('item-select');
      const quantityInput = document.getElementById('quantity-input');
      const dateInput = document.getElementById('date-input');
      const activity = select.value;
      let quantity = parseInt(quantityInput.value);
      const dateStr = dateInput.value;

      if (!activity) {
        alert('Please select an activity.');
        select.focus();
        return;
      }
      if (isNaN(quantity) || quantity <= 0) {
        alert('Please enter a valid quantity (>0).');
        quantityInput.focus();
        return;
      }
      if (!dateStr) {
        alert('Please select a valid date.');
        dateInput.focus();
        return;
      }

      const footprintPerUnit = footprintValues[activity] ?? 10;
      const footprint = footprintPerUnit * quantity;

      if (!dateUsageEntries[dateStr]) {
        dateUsageEntries[dateStr] = [];
      }

      dateUsageEntries[dateStr].push({ activity, quantity, footprint });

      saveDateUsage();
      renderDailyUsageList(dateStr);
      renderGraph();

      quantityInput.value = 1;
      document.getElementById('output').textContent = `Added: ${quantity} × ${activity} on ${formatDate(dateStr)} = ${footprint.toLocaleString()} litres`;
    }

    function renderEditableActionsList() {
      const container = document.getElementById('editable-actions-list');
      container.innerHTML = '';
      const entries = getItemList();
      if (entries.length === 0) {
        container.textContent = 'No water actions to edit.';
        return;
      }
      entries.forEach((action) => {
        const div = document.createElement('div');
        const label = document.createElement('label');
        label.textContent = action;
        label.htmlFor = `fp-input-${action}`;
        div.appendChild(label);

        const input = document.createElement('input');
        input.type = 'number';
        input.min = '0';
        input.step = '1';
        input.id = `fp-input-${action}`;
        input.value = footprintValues[action];
        input.setAttribute('aria-label', `Usage amount for ${action} in litres per unit`);
        div.appendChild(input);

        container.appendChild(div);
      });
    }

    function saveFootprintChanges() {
      const container = document.getElementById('editable-actions-list');
      const inputs = container.querySelectorAll('input[type=number]');
      let hasError = false;
      inputs.forEach(input => {
        const val = Number(input.value);
        if (isNaN(val) || val < 0) {
          alert(`Invalid value for "${input.previousSibling.textContent}". Must be a non-negative number.`);
          input.focus();
          hasError = true;
          return false;
        }
      });
      if (hasError) return;

      inputs.forEach(input => {
        const action = input.previousSibling.textContent;
        footprintValues[action] = Number(input.value);
      });

      saveFootprintValues();
      populateDropdown();
      // Refresh daily usage list for current date input
      const dateInput = document.getElementById('date-input').value;
      if (dateInput) renderDailyUsageList(dateInput);
      renderGraph();

      alert('Water usage amounts updated.');
    }

    // New function to add water action (reuse from last code)
    function addNewAction() {
      const nameInput = document.getElementById('new-action-name');
      const usageInput = document.getElementById('new-action-usage');
      const name = nameInput.value.trim();
      const usage = Number(usageInput.value);

      if (!name) {
        alert('Please enter a name for the new water action.');
        nameInput.focus();
        return;
      }

      if (isNaN(usage) || usage < 0) {
        alert('Please enter a valid non-negative number for water usage amount.');
        usageInput.focus();
        return;
      }

      if (footprintValues.hasOwnProperty(name)) {
        alert('This action already exists.');
        nameInput.focus();
        return;
      }

      footprintValues[name] = usage;
      saveFootprintValues();

      nameInput.value = '';
      usageInput.value = '';

      populateDropdown();
      renderEditableActionsList();
      alert(`Added new water action "${name}" with usage ${usage} litres per unit.`);
    }

    let chartInstance = null;
    function renderGraph() {
      const canvas = document.getElementById('usage-chart');
      if (chartInstance) {
        chartInstance.destroy();
      }

      // Calculate totals per weekday (Mon-Sun) by summing all dates matching that weekday
      const totalsByWeekday = { Mon: 0, Tue: 0, Wed: 0, Thu: 0, Fri: 0, Sat: 0, Sun: 0 };

      Object.entries(dateUsageEntries).forEach(([dateStr, entries]) => {
        const wd = getWeekdayFromDate(dateStr);
        if (wd && totalsByWeekday.hasOwnProperty(wd)) {
          const daySum = entries.reduce((sum, entry) => sum + entry.footprint, 0);
          totalsByWeekday[wd] += daySum;
        }
      });

      const labels = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
      const data = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'].map(day => totalsByWeekday[day]);

      chartInstance = new Chart(canvas.getContext('2d'), {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Total Water Usage (litres)',
            backgroundColor: '#0a74da',
            data: data
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              title: { display: true, text: 'Water Usage (litres)' }
            },
            x: {
              title: { display: true, text: 'Day of Week' }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: { mode: 'index', intersect: false }
          }
        }
      });
    }

    document.getElementById('date-input').addEventListener('change', e => {
      renderDailyUsageList(e.target.value);
      document.getElementById('output').textContent = '';
    });

    function navigate(page) {
      ['main-page', 'settings-page', 'graph-page'].forEach(id => {
        document.getElementById(id).style.display = (id === page + '-page') ? 'block' : 'none';
      });
      if (page === 'main') {
        populateDropdown();
        let dateInput = document.getElementById('date-input');
        // Default date to today if empty
        if (!dateInput.value) {
          const todayISO = new Date().toISOString().slice(0, 10);
          dateInput.value = todayISO;
        }
        renderDailyUsageList(dateInput.value);
        document.getElementById('output').textContent = '';
      } else if (page === 'settings') {
        renderEditableActionsList();
      } else if (page === 'graph') {
        renderGraph();
      }
    }

    window.onload = () => {
      loadFootprintValues();
      loadDateUsage();
      navigate('main');
    };
  </script>
</body>
</html>
